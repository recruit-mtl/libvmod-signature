varnishtest "Test signature vmod"

server s1 {
       rxreq
       txresp
} -start

varnish v1 -vcl+backend {
	import signature from "${vmod_topbuild}/src/.libs/libvmod_signature.so";

	sub vcl_deliver {
		set resp.http.Var_Message = "吾輩は猫である";
		set resp.http.Var_Signature = "I2NjSC5IM3o6II54M5Ock4pfyl0hTR1bclPNJQ+x8j9Bx8Rncz1pZZy98GP4wtSINLXFogmCQFVHok/8/PSDVLTP5x1VexovUizWjJsntfO534i1WoUyS03ArqaTwZEXV7CHCSmHu9OruBRHoPKc2iic+SEaUz8NuT2gqzuv8ZI=";
		set resp.http.Var_Public_Key = {"-----BEGIN RSA PUBLIC KEY-----
MIGJAoGBAMtTkwOx7XYzs4rNn9pNDzWtDIJkS/hwHaQnYlG39d4B941TO4rbIYUl
6NGGG+H3ObRIUNtR5FRId0PIZmy5fuyBJSeY73b1jWmLeq7Ht5EPjOTzxOYTYCCA
L+tAxNDFPcbr5OYYc324OCYV5oq4cYhH4jBYECnCzlRsvocf8cczAgMBAAE=
-----END RSA PUBLIC KEY-----"};

		set resp.http.X_Test_Result = signature.valid_signature(resp.http.Var_Message, resp.http.Var_Signature, resp.http.Var_Public_Key);

		unset resp.http.Var_Public_Key;
		unset resp.http.Var_Message;
		unset resp.http.Var_Signature;
	}
} -start

client c1 {
	txreq -url "/"
	rxresp
	expect resp.http.X_Test_Result == true
}

client c1 -run
